
import psycopg2
import logging
import yaml
from pathlib import Path

# Setup logging
logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
logger = logging.getLogger(__name__)

# Load config
BASE_DIR = Path(__file__).resolve().parent.parent
CONFIG_FILE = BASE_DIR / "config/config.yaml"

def load_db_config():
    with open(CONFIG_FILE, "r") as f:
        config = yaml.safe_load(f)
    return config["database"]

TABLE_COMMENTS = {
    "analysis_reports": "Stores detailed stock analysis reports generated by agents.",
    "forecast_rank": "Contains daily stock ranking forecasts.",
    "forex_rates": "Historical foreign exchange rate data.",
    "sector_indices": "Historical data for various market sector indices.",
    "stock_prices": "Historical daily stock price data (Open, High, Low, Close, Volume)."
}

def add_comments():
    db_config = load_db_config()
    
    try:
        conn = psycopg2.connect(**db_config)
        conn.autocommit = True
        cursor = conn.cursor()
        
        for table, comment in TABLE_COMMENTS.items():
            logger.info(f"Adding comment to table '{table}'...")
            sql = f"COMMENT ON TABLE {table} IS '{comment}';"
            try:
                cursor.execute(sql)
                logger.info(f"Successfully added comment to '{table}'.")
            except Exception as e:
                logger.error(f"Failed to add comment to '{table}': {e}")
                
        cursor.close()
        conn.close()
        logger.info("Finished adding comments.")
        
    except Exception as e:
        logger.error(f"Database connection failed: {e}")

if __name__ == "__main__":
    add_comments()
